<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Photos Swiper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
        }
        .photo-item {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center h-screen overflow-hidden">

    <div id="main-container" class="w-full h-full flex items-center justify-center">

        <!-- Login View -->
        <div id="login-view" class="text-center">
            <h1 class="text-3xl font-bold mb-4">Photo Swiper</h1>
            <p class="text-gray-400 mb-8">Sign in to view your Google Photos.</p>
            <button id="signin-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                Sign In with Google
            </button>
        </div>

        <!-- Photo View -->
        <div id="photo-view" class="hidden w-full h-full flex flex-col items-center justify-center relative">
            <div id="loading-indicator" class="text-center">
                <p>Loading photos...</p>
            </div>
            <div id="photo-container" class="w-full h-full flex items-center justify-center absolute top-0 left-0">
                <!-- Photos will be loaded here -->
            </div>
            <button id="signout-button" class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg z-20 shadow-lg">
                Sign Out
            </button>
        </div>
    </div>

    <script>
        const CLIENT_ID = '323282706150-lml37ocsounuirl5oree5cktpqqrtck0.apps.googleusercontent.com'; // <-- IMPORTANT: PASTE YOUR GOOGLE CLIENT ID HERE
        const SCOPES = 'https://www.googleapis.com/auth/photoslibrary.readonly';

        const loginView = document.getElementById('login-view');
        const photoView = document.getElementById('photo-view');
        const signinButton = document.getElementById('signin-button');
        const signoutButton = document.getElementById('signout-button');
        const photoContainer = document.getElementById('photo-container');
        const loadingIndicator = document.getElementById('loading-indicator');

        let tokenClient;
        let photos = [];
        let currentIndex = 0;

        // --- GAPI Setup ---

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
             if (!CLIENT_ID || CLIENT_ID === 'YOUR_CLIENT_ID_HERE') {
                alert('Please enter your Google Client ID in the script section of this file.');
                return;
            }
            // Initialize the GAPI client for the Photos API
            await gapi.client.init({
                discoveryDocs: ['https://photoslibrary.googleapis.com/$discovery/rest?version=v1'],
            });
        }

        function gisLoaded() {
            // Initialize the GIS client
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleTokenResponse, // Centralized callback function
            });
        }

        function handleTokenResponse(tokenResponse) {
            if (tokenResponse && tokenResponse.error) {
                console.error("Error from token response:", tokenResponse);
                alert(`Authentication Error: ${tokenResponse.error_description || tokenResponse.error}`);
                updateUI(false);
                return;
            }

            if (tokenResponse && tokenResponse.access_token) {
                console.log("Successfully received access token.");
                // Set the token for GAPI client to use
                gapi.client.setToken(tokenResponse);
                updateUI(true);
                loadPhotos();
            }
        }

        // --- Authentication ---

        function handleSignIn() {
            console.log("Sign-in button clicked. Forcing consent prompt.");
            // This will always ask the user for permission, ensuring the correct scopes are requested.
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        function handleSignOut() {
            console.log("Sign-out initiated.");
            const token = gapi.client.getToken();
            if (token !== null) {
                // Revoke the token to remove app access for the user
                google.accounts.oauth2.revoke(token.access_token, () => {
                    console.log('Access token revoked.');
                });
                // Immediately clear the token from the client
                gapi.client.setToken('');
            }
            // Reset the UI and app state
            photos = [];
            currentIndex = 0;
            photoContainer.innerHTML = '';
            updateUI(false);
        }

        // --- UI Control ---

        function updateUI(isSignedIn) {
            if (isSignedIn) {
                loginView.classList.add('hidden');
                photoView.classList.remove('hidden');
            } else {
                loginView.classList.remove('hidden');
                photoView.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
                loadingIndicator.innerText = 'Loading photos...';
            }
        }

        // --- Photo Loading and Display ---

        async function loadPhotos() {
            loadingIndicator.classList.remove('hidden');
            photoContainer.innerHTML = '';
            try {
                let allPhotos = [];
                let nextPageToken = null;

                console.log("Attempting to load photos from the API...");
                // Fetch up to 300 photos to get a good random selection
                for (let i = 0; i < 3; i++) {
                    const response = await gapi.client.photoslibrary.mediaItems.list({
                        pageSize: 100,
                        pageToken: nextPageToken,
                    });

                    if (response.result.mediaItems) {
                        const photoItems = response.result.mediaItems.filter(item => item.mimeType.startsWith('image/'));
                        allPhotos.push(...photoItems);
                    }
                    
                    nextPageToken = response.result.nextPageToken;
                    if (!nextPageToken) break;
                }
                console.log(`Loaded ${allPhotos.length} photos.`);

                photos = shuffleArray(allPhotos);
                if (photos.length > 0) {
                    loadingIndicator.classList.add('hidden');
                    displayPhoto(currentIndex);
                } else {
                    loadingIndicator.innerText = 'No photos found in your library.';
                }

            } catch (err) {
                console.error("Error loading photos:", err);
                const errorBody = err.body ? JSON.parse(err.body) : { error: { message: "Unknown error" } };
                loadingIndicator.innerText = `Failed to load photos. Error: ${errorBody.error.message}`;
                // Automatically sign out on permission errors to allow a clean retry
                handleSignOut();
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function displayPhoto(index) {
            if (index < 0 || index >= photos.length) return;
            
            const photo = photos[index];
            const imageUrl = `${photo.baseUrl}=w${window.innerWidth}-h${window.innerHeight}`;
            
            photoContainer.innerHTML = `<img src="${imageUrl}" class="photo-item max-w-full max-h-full object-contain" draggable="false">`;
        }

        // --- Swipe Logic ---
        let touchstartX = 0, touchstartY = 0, touchendX = 0, touchendY = 0;

        photoContainer.addEventListener('touchstart', e => {
            touchstartX = e.changedTouches[0].screenX;
            touchstartY = e.changedTouches[0].screenY;
        }, { passive: true });

        photoContainer.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            touchendY = e.changedTouches[0].screenY;
            handleGesture();
        });

        function handleGesture() {
            const deltaX = touchendX - touchstartX;
            const deltaY = touchendY - touchstartY;

            if (Math.abs(deltaX) > Math.abs(deltaY)) { // Horizontal swipe
                if (deltaX < -50) { // Swiped left
                    currentIndex = (currentIndex + 1) % photos.length;
                    displayPhoto(currentIndex);
                }
                if (deltaX > 50) { // Swiped right
                    currentIndex = (currentIndex - 1 + photos.length) % photos.length;
                    displayPhoto(currentIndex);
                }
            }
        }

        // --- Event Listeners ---
        signinButton.addEventListener('click', handleSignIn);
        signoutButton.addEventListener('click', handleSignOut);

    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>

When you test this, you should see the Google pop-up asking for permission to "View your Google Photos library" every single time you click the sign-in button. Please make sure you check the box and approve it. This should finally provide the app with the correctly-scoped token it needs.
