<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Photos Swiper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
        }
        .photo-item {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .photo-container {
            transition: transform 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center h-screen overflow-hidden">

    <div id="main-container" class="w-full h-full flex items-center justify-center">

        <!-- Login View -->
        <div id="login-view" class="text-center">
            <h1 class="text-3xl font-bold mb-4">Photo Swiper</h1>
            <p class="text-gray-400 mb-8">Sign in to view your Google Photos.</p>
            <button id="signin-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                Sign In with Google
            </button>
             <div class="mt-8 p-4 bg-gray-800 rounded-lg text-sm text-gray-300 max-w-md mx-auto">
                <h3 class="font-bold text-white mb-2">How to get your Client ID:</h3>
                <ol class="list-decimal list-inside text-left">
                    <li>Go to the <a href="https://console.cloud.google.com/" target="_blank" class="text-blue-400 hover:underline">Google Cloud Console</a>.</li>
                    <li>Create a new project.</li>
                    <li>Go to "APIs & Services" > "Credentials".</li>
                    <li>Click "Create Credentials" > "OAuth client ID".</li>
                    <li>Select "Web application" as the type.</li>
                    <li>Under "Authorized JavaScript origins", add the URL where you're hosting this app (e.g., your GitHub Pages URL).</li>
                    <li>Copy the generated "Client ID" and paste it into the code.</li>
                </ol>
            </div>
        </div>

        <!-- Photo View -->
        <div id="photo-view" class="hidden w-full h-full flex flex-col items-center justify-center relative">
            <div id="loading-indicator" class="text-center">
                <p>Loading photos...</p>
            </div>
            <div id="photo-container" class="w-full h-full flex items-center justify-center absolute top-0 left-0">
                <!-- Photos will be loaded here -->
            </div>
            <button id="signout-button" class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg z-20 shadow-lg">
                Sign Out
            </button>
        </div>
    </div>

    <script>
        const CLIENT_ID = '323282706150-lml37ocsounuirl5oree5cktpqqrtck0.apps.googleusercontent.com'; // <-- IMPORTANT: PASTE YOUR GOOGLE CLIENT ID HERE
        const SCOPES = 'https://www.googleapis.com/auth/photoslibrary.readonly';

        const loginView = document.getElementById('login-view');
        const photoView = document.getElementById('photo-view');
        const signinButton = document.getElementById('signin-button');
        const signoutButton = document.getElementById('signout-button');
        const photoContainer = document.getElementById('photo-container');
        const loadingIndicator = document.getElementById('loading-indicator');

        let gapiClient;
        let tokenClient;
        let photos = [];
        let currentIndex = 0;

        // --- GAPI Setup ---

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            if (!CLIENT_ID || CLIENT_ID === 'YOUR_CLIENT_ID_HERE') {
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed top-5 left-1/2 -translate-x-1/2 bg-red-500 text-white p-4 rounded-lg shadow-lg';
                messageBox.innerText = 'Please enter your Google Client ID in the script section of this file.';
                document.body.appendChild(messageBox);
                setTimeout(() => messageBox.remove(), 5000);
                return;
            }
            await gapi.client.init({
                // apiKey is not needed for Photos Library API with OAuth
                discoveryDocs: ['https://photoslibrary.googleapis.com/$discovery/rest?version=v1'],
            });
            gapiClient = gapi.client;
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    // This callback is triggered after user grants consent or if a valid token is found.
                    if (tokenResponse && tokenResponse.error) {
                        console.error("Token Error:", tokenResponse.error);
                        return;
                    }
                    console.log("Received token response:", tokenResponse);
                    if (tokenResponse && tokenResponse.access_token) {
                        gapi.client.setToken(tokenResponse);
                        updateUI(true);
                        loadPhotos();
                    }
                },
            });
        }

        // --- Authentication ---

        function handleSignIn() {
            // Request a new token. 'prompt: consent' will force the consent screen to appear,
            // which is crucial for ensuring the user grants the correct scopes.
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        function handleSignOut() {
            const token = gapi.client.getToken();
            if (token !== null) {
                // Revoke the token to remove the app's access.
                google.accounts.oauth2.revoke(token.access_token, () => {
                    console.log('Access token revoked.');
                    // Clear the local gapi client token
                    gapi.client.setToken('');
                    // Reset app state
                    photos = [];
                    currentIndex = 0;
                    photoContainer.innerHTML = '';
                    updateUI(false);
                });
            }
        }

        // --- UI Control ---

        function updateUI(isSignedIn) {
            if (isSignedIn) {
                loginView.classList.add('hidden');
                photoView.classList.remove('hidden');
            } else {
                loginView.classList.remove('hidden');
                photoView.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
                loadingIndicator.innerText = 'Loading photos...';
            }
        }


        // --- Photo Loading and Display ---

        async function loadPhotos() {
            loadingIndicator.classList.remove('hidden');
            photoContainer.innerHTML = '';
            try {
                let allPhotos = [];
                let nextPageToken = null;

                // Fetch a few pages of photos to get a good random selection
                for (let i = 0; i < 3; i++) {
                    const response = await gapi.client.photoslibrary.mediaItems.list({
                        pageSize: 100, // Max page size
                        pageToken: nextPageToken,
                    });

                    if (response.result.mediaItems) {
                        const photoItems = response.result.mediaItems.filter(item => item.mimeType.startsWith('image/'));
                        allPhotos.push(...photoItems);
                    }
                    
                    nextPageToken = response.result.nextPageToken;
                    if (!nextPageToken) break;
                }

                photos = shuffleArray(allPhotos);
                if (photos.length > 0) {
                    loadingIndicator.classList.add('hidden');
                    displayPhoto(currentIndex);
                } else {
                    loadingIndicator.innerText = 'No photos found in your library.';
                }

            } catch (err) {
                console.error("Error loading photos: ", err);
                const errorBody = JSON.parse(err.body);
                loadingIndicator.innerText = `Failed to load photos. Error: ${errorBody.error.message}`;
                // If token is expired or permission is denied, sign out to force re-login
                if (err.result && err.result.error && (err.result.error.code === 16 || err.result.error.code === 403)) {
                    handleSignOut();
                }
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function displayPhoto(index) {
            if (index < 0 || index >= photos.length) return;
            
            const photo = photos[index];
            const imageUrl = `${photo.baseUrl}=w${window.innerWidth}-h${window.innerHeight}`;
            
            photoContainer.innerHTML = `
                <img src="${imageUrl}" class="photo-item max-w-full max-h-full object-contain" draggable="false">
            `;
        }

        // --- Swipe Logic ---
        let touchstartX = 0;
        let touchstartY = 0;
        let touchendX = 0;
        let touchendY = 0;

        function handleGesture() {
            const deltaX = touchendX - touchstartX;
            const deltaY = touchendY - touchstartY;

            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                if (deltaX < -50) { // Swiped left
                    currentIndex = (currentIndex + 1) % photos.length;
                    displayPhoto(currentIndex);
                }
                if (deltaX > 50) { // Swiped right
                    currentIndex = (currentIndex - 1 + photos.length) % photos.length;
                    displayPhoto(currentIndex);
                }
            }
        }

        photoContainer.addEventListener('touchstart', e => {
            touchstartX = e.changedTouches[0].screenX;
            touchstartY = e.changedTouches[0].screenY;
        }, { passive: true });

        photoContainer.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            touchendY = e.changedTouches[0].screenY;
            handleGesture();
        });

        // --- Event Listeners ---
        signinButton.addEventListener('click', handleSignIn);
        signoutButton.addEventListener('click', handleSignOut);

    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
